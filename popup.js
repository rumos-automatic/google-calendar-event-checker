(()=>{function a(d){let e=document.getElementById(d);if(!e)throw new Error(`Missing required element: ${d}`);return e}var g=class{constructor(){this.signInHandler=null;this.root=a("signInView"),this.signInButton=a("signInBtn"),this.permissionToggle=a("permissionInfoToggle"),this.permissionPanel=a("permissionInfoPanel"),this.signInButton.addEventListener("click",()=>{this.signInHandler&&this.signInHandler()}),this.permissionToggle.addEventListener("click",e=>{e.stopPropagation(),this.togglePermissionInfo()}),this.root.addEventListener("click",e=>{if(!this.permissionPanel.classList.contains("show"))return;let t=e.target,i=t===this.permissionToggle||this.permissionToggle.contains(t),s=this.permissionPanel.contains(t);!i&&!s&&this.setPermissionInfoVisible(!1)}),this.permissionPanel.addEventListener("click",e=>{e.stopPropagation()})}get element(){return this.root}bindSignIn(e){this.signInHandler=e}setAuthenticatingState(e){e?(this.signInButton.disabled=!0,this.signInButton.textContent="\u{1F504} 認証中..."):(this.signInButton.disabled=!1,this.signInButton.textContent="\u{1F510} Googleでサインイン")}show(){this.root.classList.add("active")}hide(){this.root.classList.remove("active"),this.setPermissionInfoVisible(!1)}setPermissionInfoVisible(e){let t=e?"true":"false";this.permissionPanel.classList.toggle("show",e),this.permissionToggle.setAttribute("aria-expanded",t),this.permissionToggle.title=e?"Hide Google permission details":"Why we request Google permissions?"}togglePermissionInfo(){let e=this.permissionPanel.classList.contains("show");this.setPermissionInfoVisible(!e)}};var M="event-checkbox-loading",f=class{constructor(e){this.currentDate=new Date;this.events=[];this.eventItemRefs=new Map;this.isVisible=!1;this.root=a("eventsView"),this.currentDateLabel=a("currentDate"),this.countLabel=a("eventsCount"),this.eventsList=a("eventsList"),this.prevDayButton=a("prevDayBtn"),this.nextDayButton=a("nextDayBtn"),this.userOptionsButton=a("userOptionsBtn"),this.deps=e,this.prevDayButton.addEventListener("click",()=>this.navigateDay(-1)),this.nextDayButton.addEventListener("click",()=>this.navigateDay(1)),this.userOptionsButton.addEventListener("click",()=>this.deps.onOptions()),window.addEventListener("focus",()=>{this.isVisible&&this.refresh()})}show(){this.isVisible=!0,this.root.classList.add("active")}hide(){this.isVisible=!1,this.root.classList.remove("active")}async refresh(){await this.loadEvents()}async clearCache(){try{let e=await chrome.storage.local.get(),t=Object.keys(e).filter(i=>i.startsWith("events_"));t.length>0&&await chrome.storage.local.remove(t)}catch(e){console.error("Error clearing events cache:",e)}}async loadEvents(){this.updateDateLabel();let e=await this.loadCachedEvents(this.currentDate);if(e){this.events=e,this.render(this.events),this.fetchEventsInBackground(new Date(this.currentDate));return}this.showLoading("イベントを読み込み中..."),await this.fetchEventsInBackground(new Date(this.currentDate))}async fetchEventsInBackground(e){try{let t=Intl.DateTimeFormat().resolvedOptions().timeZone,i=this.getDateString(e),s=await this.deps.sendMessage({action:"listEventsDirect",date:i,timeZone:t});if(s.success){let r=s.events||[];await this.saveCachedEvents(e,r),this.isSameDay(e,this.currentDate)&&(this.events=r,this.render(this.events));return}if(s.code==="RATE_LIMITED"){let r=typeof s.error=="string"&&s.error.length>0?s.error:"短時間に多数のイベント更新が行われました。しばらくしてからお試しください。",c=this.deps.showRateLimitNotification(r,s.retryAfterSeconds);this.isSameDay(e,this.currentDate)&&this.showError(c);return}let n=new Error(s.error||"Failed to load events");throw s.code&&(n.code=s.code),typeof s.retryAfterSeconds=="number"&&(n.retryAfterSeconds=s.retryAfterSeconds),n}catch(t){if(console.error("Error loading events:",t),t?.code==="RATE_LIMITED"){let i=t.message||"短時間に多数のイベント更新が行われました。しばらくしてからお試しください。",s=this.deps.showRateLimitNotification(i,t.retryAfterSeconds);this.isSameDay(e,this.currentDate)&&this.showError(s);return}this.isSameDay(e,this.currentDate)&&this.showError("イベントの読み込みに失敗しました"),this.deps.notify("イベントの読み込みに失敗しました","error"),t?.message?.includes("Authentication")&&this.deps.onAuthFailure()}}navigateDay(e){this.currentDate.setDate(this.currentDate.getDate()+e),this.refresh()}updateDateLabel(){this.currentDateLabel.textContent=this.formatDate(this.currentDate)}showLoading(e){this.countLabel.textContent="0 events",this.eventsList.innerHTML=`<div style="text-align: center; padding: 40px; color: #666;">${e}</div>`,this.eventItemRefs.clear()}showError(e){this.countLabel.textContent="0 events",this.eventsList.innerHTML=`<div style="text-align: center; padding: 40px; color: #c62828;">${e}</div>`,this.eventItemRefs.clear()}render(e){if(this.countLabel.textContent=`${e.length} event${e.length!==1?"s":""}`,this.eventsList.innerHTML="",this.eventItemRefs.clear(),e.length===0){this.eventsList.innerHTML=`
        <div class="no-events">
          <div class="no-events-icon">\u{1F4ED}</div>
          <div class="no-events-text">No events</div>
          <div class="no-events-subtext">Nothing scheduled for this day</div>
        </div>
      `;return}e.forEach(t=>{let{element:i,refs:s}=this.createEventElement(t);this.eventItemRefs.set(t.id,s),this.eventsList.appendChild(i)})}createEventElement(e){let t=document.createElement("div");t.className="event-item";let i=document.createElement("div");i.className="event-checkbox-wrapper";let s=document.createElement("input");s.type="checkbox",s.className="event-checkbox",s.checked=this.isEventCompleted(e),s.addEventListener("change",()=>{this.handleEventToggle(e.id)});let n=document.createElement("div");n.className="checkbox-loader",i.appendChild(s),i.appendChild(n);let r=document.createElement("div");r.className="calendar-indicator",r.style.backgroundColor=e.calendarColor||"#1a73e8",r.title=e.calendarName||"Calendar";let c=document.createElement("div");c.className="event-content";let l=e.htmlLink?document.createElement("a"):document.createElement("span");if(l.className="event-title"+(this.isEventCompleted(e)?" completed":""),l.textContent=e.summary??"",e.htmlLink){let u=l;u.href=e.htmlLink,u.target="_blank",u.rel="noopener noreferrer"}let h=document.createElement("div");h.className="event-time",h.textContent=this.formatTime(e.start,e.end);let o=document.createElement("div");return o.className="calendar-name",o.textContent=e.calendarName||"",c.appendChild(l),c.appendChild(h),e.calendarName&&c.appendChild(o),t.appendChild(i),t.appendChild(r),t.appendChild(c),{element:t,refs:{checkbox:s,wrapper:i,loader:n,title:l}}}async handleEventToggle(e){let t=this.events.find(n=>n.id===e);if(!t)return;let i=this.eventItemRefs.get(e);if(!i)return;let s=!!t.isCompleted;i.wrapper.classList.add(M),i.checkbox.disabled=!0;try{let n=await this.deps.sendMessage({action:"modifyEventDirect",htmlLink:`${t.id}_${t.calendarId}`});if(n.success){t.isCompleted=!t.isCompleted,t.summary=n.summary,await this.saveCachedEvents(this.currentDate,this.events),this.updateEventItem(t);let r=n.action==="marked"?"completed":"incomplete";this.deps.notify(`イベントを${r==="completed"?"完了":"未完了"}としてマーク`,"success");return}if(n.code==="RATE_LIMITED"){i.checkbox.checked=s;let r=typeof n.error=="string"&&n.error.length>0?n.error:"短時間に多数のイベント更新が行われました。しばらくしてからお試しください。";this.deps.showRateLimitNotification(r,n.retryAfterSeconds);return}throw i.checkbox.checked=s,new Error(n.error||"Failed to update event")}catch(n){if(console.error("Error toggling event:",n),i.checkbox.checked=s,n?.code==="RATE_LIMITED"){let r=n.message||"短時間に多数のイベント更新が行われました。しばらくしてからお試しください。";this.deps.showRateLimitNotification(r,n.retryAfterSeconds)}else this.deps.notify("イベントの更新に失敗しました","error");n?.message?.includes("Authentication")&&this.deps.onAuthFailure()}finally{i.wrapper.classList.remove(M),i.checkbox.disabled=!1}}updateEventItem(e){let t=this.eventItemRefs.get(e.id);if(!t)return;let i=this.isEventCompleted(e);t.checkbox.checked=i,t.title.classList.toggle("completed",i),t.title.textContent=e.summary??""}isEventCompleted(e){let t=e.summary?.startsWith("\u2705"),i=e.summary?.includes("\u0336");return t||i}formatDate(e){let t={month:"long",day:"numeric",weekday:"short"};return e.toLocaleDateString("en-US",t)}formatTime(e,t){if(!e?.dateTime&&e?.date)return"All day";let i=new Date(e.dateTime||e.date),s=new Date(t?.dateTime||t?.date||i),n=i.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0}),r=s.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit",hour12:!0});return`${n} - ${r}`}getDateString(e){let t=e.getFullYear(),i=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0");return`${t}-${i}-${s}`}isSameDay(e,t){return e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate()}getCacheKey(e){return`events_${this.getDateString(e)}`}async loadCachedEvents(e){try{let t=this.getCacheKey(e),i=await chrome.storage.local.get([t]);if(i[t]){let s=i[t],n=Date.now()-s.timestamp,r=5*60*1e3;if(n<r)return s.events}}catch(t){console.error("Error loading cached events:",t)}return null}async saveCachedEvents(e,t){try{let i=this.getCacheKey(e);await chrome.storage.local.set({[i]:{events:t,timestamp:Date.now()}})}catch(i){console.error("Error caching events:",i)}}};var w=class{constructor(e){this.currentIndex=0;this.canStartTrial=!1;this.root=a("carouselView"),this.track=a("carouselTrack"),this.dotsContainer=a("carouselDots"),this.closeButton=a("carouselCloseBtn"),this.prevButton=a("carouselPrevBtn"),this.nextButton=a("carouselNextBtn"),this.activateButton=a("carouselActivateBtn"),this.slides=Array.from(this.track.querySelectorAll(".carousel-slide")),this.callbacks=e,this.setupDots(),this.bindEvents(),this.update()}get element(){return this.root}get length(){return this.slides.length}reset(){this.currentIndex=0,this.update()}show(){this.root.classList.add("active")}hide(){this.root.classList.remove("active")}setTrialAvailability(e){this.canStartTrial=e,this.updateActivateButton()}updateActivateButton(){this.canStartTrial?this.activateButton.textContent="14日間トライアルを開始":this.activateButton.textContent="プレミアムを有効化"}next(){this.currentIndex>=this.slides.length-1||(this.currentIndex+=1,this.update())}prev(){this.currentIndex!==0&&(this.currentIndex-=1,this.update())}setupDots(){this.dotsContainer.innerHTML="",this.slides.forEach((e,t)=>{let i=document.createElement("button");i.type="button",i.className="carousel-dot",i.setAttribute("aria-label",`Go to slide ${t+1}`),i.addEventListener("click",()=>{this.currentIndex=t,this.update()}),this.dotsContainer.appendChild(i)})}bindEvents(){this.closeButton.addEventListener("click",()=>this.callbacks.onClose()),this.prevButton.addEventListener("click",()=>this.prev()),this.nextButton.addEventListener("click",()=>this.next()),this.activateButton.addEventListener("click",()=>this.callbacks.onActivatePremium())}update(){if(this.slides.length===0){this.prevButton.disabled=!0,this.nextButton.setAttribute("aria-label","Close onboarding");return}let e=-1*this.currentIndex*100;this.track.style.transform=`translateX(${e}%)`,this.slides.forEach((s,n)=>{let r=n===this.currentIndex;s.classList.toggle("active",r),s.setAttribute("aria-hidden",r?"false":"true")}),Array.from(this.dotsContainer.querySelectorAll(".carousel-dot")).forEach((s,n)=>{s.classList.toggle("active",n===this.currentIndex)}),this.prevButton.disabled=this.currentIndex===0,this.nextButton.disabled=this.currentIndex>=this.slides.length-1;let i=this.currentIndex>=this.slides.length-1;this.nextButton.setAttribute("aria-label",i?"Last slide":"Next slide")}};var b=class{constructor(e){this.root=a("premiumView"),this.upgradeButton=a("premiumUpgradeBtn"),this.trialButton=a("premiumStartTrialBtn"),this.userOptionsButton=a("premiumUserOptionsBtn"),this.titleElement=a("premiumSectionTitle"),this.descriptionElement=a("premiumSectionDescription"),this.footnoteElement=a("premiumFootnote"),this.bindAsyncButton(this.upgradeButton,e.onUpgrade),this.trialButton.addEventListener("click",()=>e.onStartTrial()),this.userOptionsButton.addEventListener("click",()=>e.onOpenOptions())}get element(){return this.root}show(){this.root.classList.add("active")}hide(){this.root.classList.remove("active")}setTrialAvailability(e){let t=e?"fresh":"trial-expired";this.updateContent(t),e?(this.trialButton.classList.remove("hidden"),this.upgradeButton.classList.add("hidden")):(this.trialButton.classList.add("hidden"),this.upgradeButton.classList.remove("hidden"))}setUpgradeAvailability(e){e&&(this.updateContent("subscription-expired"),this.upgradeButton.classList.remove("hidden"),this.trialButton.classList.add("hidden"))}updateContent(e){switch(e){case"fresh":this.titleElement.textContent="Unlock Premium Features",this.descriptionElement.textContent="Get more out of your calendar with these powerful features",this.footnoteElement.textContent="No credit card required";break;case"trial-expired":this.titleElement.textContent="Your Trial Has Ended",this.descriptionElement.textContent="Continue enjoying premium features with a paid subscription",this.footnoteElement.textContent="Cancel anytime";break;case"subscription-expired":this.titleElement.textContent="Renew Your Subscription",this.descriptionElement.textContent="Your subscription has expired. Upgrade to continue using premium features",this.footnoteElement.textContent="Cancel anytime";break}}bindAsyncButton(e,t){t&&e.addEventListener("click",()=>{this.runButtonAction(e,t)})}async runButtonAction(e,t){if(e.dataset.loading!=="true"){this.setButtonLoading(e,!0);try{await t()}finally{this.setButtonLoading(e,!1)}}}setButtonLoading(e,t){if(t){e.dataset.loading="true",e.dataset.originalContent||(e.dataset.originalContent=e.innerHTML),e.dataset.originalWidth||(e.dataset.originalWidth=`${e.offsetWidth}px`),e.dataset.originalHeight||(e.dataset.originalHeight=`${e.offsetHeight}px`),e.style.width=e.dataset.originalWidth,e.style.height=e.dataset.originalHeight,e.disabled=!0,e.innerHTML='<span class="button-spinner"></span> Loading...';return}e.dataset.loading="false",e.disabled=!1,e.style.width="",e.style.height="",e.dataset.originalContent&&(e.innerHTML=e.dataset.originalContent)}};var y=class{constructor(e){this.container=a("subscriptionStatus"),this.callbacks=e}showLoading(e){this.container.innerHTML=`<div class="subscription-loading">${e}</div>`}showError(e){this.container.innerHTML=`
      <div class="subscription-error">
        \u26A0\uFE0F ${e}
      </div>
    `}render(e,t){let{canStartCardlessTrial:i}=t,s=Date.now(),n='<a href="mailto:support@calcheckr.com">support@calcheckr.com</a>',r=e.cardlessTrialActive&&e.endsAt?new Date(e.endsAt):null,c=e.cancelAt?new Date(e.cancelAt):null,l=e.currentPeriodEnd?new Date(e.currentPeriodEnd):null,h=e.startedAt?new Date(e.startedAt):null,o=p=>p?p.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):"",u=r&&r.getTime()>s?Math.max(0,Math.ceil((r.getTime()-s)/(24*60*60*1e3))):0,A=p=>{let m=document.getElementById(p);m&&this.bindAsyncAction(m,this.callbacks.onUpgrade)};if(e.hasActiveSubscription){if(e.accessSource==="cardless_trial"){this.container.innerHTML=`
          <div class="subscription-card trial">
            <div class="subscription-header">
              <span class="subscription-status-badge">
                \u{1F389} トライアル有効
              </span>
            </div>
            <div class="subscription-plan">14日間プレミアムトライアル</div>
            <div class="subscription-expiry">
              トライアル終了日：${o(r)}
            </div>
            <div class="subscription-hint">
              残り${u}日 \u2014 プレミアムを有効化してパワーアップを維持！
            </div>
            <button class="upgrade-btn" id="activateStripeUpgradeBtn">
              \u{1F680} プレミアムサブスクリプションを有効化
            </button>
          </div>
        `,A("activateStripeUpgradeBtn");return}let p=c?`キャンセル日：${o(c)}`:l?`更新日：${o(l)}`:"サブスクリプション有効",m=l?`トライアル終了日：${o(l)}`:"トライアル有効";this.container.innerHTML=`
        <div class="subscription-card">
          <div class="subscription-header">
            <span class="subscription-status-badge">
              <span>\u2713</span> プレミアム有効
            </span>
          </div>
          <div class="subscription-plan">Stripeサブスクリプション</div>
          <div class="subscription-expiry">
            ${e.state==="trialing"?m:p}
          </div>
          <button class="manage-subscription-btn" id="manageSubscriptionBtn">
            \u2699\uFE0F サブスクリプション管理
          </button>
        </div>
      `;let v=document.getElementById("manageSubscriptionBtn");v&&this.bindAsyncAction(v,this.callbacks.onOpenBillingPortal);return}if(e.accessSource==="stripe"){let m={active:"Subscription Active",trialing:"Subscription Trialing",past_due:"Payment Past Due",canceled:"Subscription Cancelled",incomplete:"Checkout Incomplete",incomplete_expired:"Checkout Expired",unpaid:"Subscription Marked Unpaid"}[e.state]||`Subscription ${e.state}`,v=e.canceledAt?new Date(e.canceledAt):null,V=v?`Cancelled on ${o(v)}`:c?`Cancels on ${o(c)}`:l?`Billing cycle ended on ${o(l)}`:"Check Stripe Billing Portal for more details.",P=e.state==="canceled"?`<p class="subscription-feedback below-card">Thanks for giving Premium a try. If you have questions or feedback, email ${n} and I'll help out.</p>`:"",I=e.state==="canceled"?"subscription-card canceled":"subscription-card free";this.container.innerHTML=`
        <div class="${I}">
          <div class="subscription-header">
            <span class="subscription-status-badge">${m}</span>
          </div>
          <div class="subscription-plan">Stripe Subscription</div>
          <div class="subscription-expiry">
            ${V}
          </div>
          <button class="upgrade-btn" id="reactivateSubscriptionBtn">
            \u{1F680} Renew Premium
          </button>
        </div>
        ${P}
      `;let k=document.getElementById("reactivateSubscriptionBtn");k&&this.bindAsyncAction(k,this.callbacks.onUpgrade);return}if(i){this.container.innerHTML=`
        <div class="subscription-card trial-offer">
          <div class="subscription-header">
            <span class="subscription-status-badge">Premium Trial</span>
          </div>
          <div class="subscription-plan">14日間のプレミアムアクセスを開始</div>
          <div class="subscription-expiry">
            クレジットカード不要 \u2014 すべてのプレミアム機能に即座にアクセス
          </div>
          <button class="upgrade-btn" id="startCardlessTrialBtn">
            \u{1F680} 14日間トライアルを開始
          </button>
        </div>
      `,document.getElementById("startCardlessTrialBtn")?.addEventListener("click",()=>this.callbacks.onActivateCardlessTrial());return}if(e.accessSource==="cardless_trial"&&e.cardlessTrialConsumed){this.container.innerHTML=`
        <div class="subscription-card trial-ended">
          <div class="subscription-header">
            <span class="subscription-status-badge">Trial Complete</span>
          </div>
          <div class="subscription-plan">14-day premium trial ended</div>
          <div class="subscription-expiry">
            ${h?`Started ${o(h)}.`:"Premium trial consumed."}
          </div>
          <button class="upgrade-btn" id="trialEndedUpgradeBtn">
            \u{1F680} Activate Premium Subscription
          </button>
        </div>
        <p class="subscription-feedback trial-ended-note">
          Thanks for trying the trial! If you spotted a bug or have feedback, please write to
          ${n}.
        </p>
      `,A("trialEndedUpgradeBtn");return}this.container.innerHTML=`
      <div class="subscription-card free">
        <div class="subscription-header">
          <span class="subscription-status-badge">無料プラン</span>
        </div>
        <div class="subscription-plan">基本機能</div>
        <div class="subscription-expiry">アップグレードして無制限アクセスをアンロック</div>
        <button class="upgrade-btn" id="userOptionsUpgradeBtn">
          \u{1F680} プレミアムにアップグレード
        </button>
      </div>
    `,A("userOptionsUpgradeBtn")}bindAsyncAction(e,t){t&&e.addEventListener("click",()=>{this.handleAsyncButton(e,t)})}async handleAsyncButton(e,t){if(e.dataset.loading!=="true"){this.setButtonLoading(e,!0);try{await t()}finally{this.setButtonLoading(e,!1)}}}setButtonLoading(e,t){if(t){e.dataset.loading="true",e.dataset.originalContent||(e.dataset.originalContent=e.innerHTML),e.dataset.originalWidth||(e.dataset.originalWidth=`${e.offsetWidth}px`),e.dataset.originalHeight||(e.dataset.originalHeight=`${e.offsetHeight}px`),e.style.width=e.dataset.originalWidth,e.style.height=e.dataset.originalHeight,e.disabled=!0,e.innerHTML='<span class="button-spinner"></span> Loading...';return}e.dataset.loading="false",e.disabled=!1,e.style.width="",e.style.height="",e.dataset.originalContent&&(e.innerHTML=e.dataset.originalContent)}};var T=class{constructor(e){this.container=a("calendarsList"),this.callbacks=e}showLoading(){this.container.innerHTML='<div class="loading-calendars">カレンダーを読み込み中...</div>'}showError(e){this.container.innerHTML=`<div class="no-calendars">${e}</div>`}render(e,t){if(this.container.innerHTML="",e.length===0){this.container.innerHTML='<div class="no-calendars">利用可能なカレンダーがありません</div>';return}e.forEach(i=>{let s=document.createElement("div");s.className="calendar-item";let n=document.createElement("input");n.type="checkbox",n.checked=t.includes(i.id),n.id=`calendar-${i.id}`,n.addEventListener("change",o=>{let u=o.target;this.callbacks.onToggleCalendar(i.id,u.checked,u)});let r=document.createElement("div");r.className="calendar-color-dot",r.style.backgroundColor=i.backgroundColor||"#1a73e8";let c=document.createElement("div");c.className="calendar-info";let l=document.createElement("div");l.className="calendar-name",l.textContent=i.summary||"Unnamed Calendar";let h=document.createElement("div");if(h.className="calendar-role",h.textContent=i.accessRole==="owner"?"Owner":"Editor",i.primary){let o=document.createElement("span");o.className="calendar-primary-badge",o.textContent="Primary",h.appendChild(o)}c.appendChild(l),c.appendChild(h),s.appendChild(n),s.appendChild(r),s.appendChild(c),s.addEventListener("click",o=>{o.target!==n&&n.click()}),this.container.appendChild(s)})}};var E=class{constructor(e){this.signOutAllDevicesButton=a("signOutAllDevicesBtn"),this.callbacks=e,this.signOutAllDevicesButton.addEventListener("click",()=>this.callbacks.onSignOutAllDevices()),this.signOutAllDevicesButton.textContent="\u{1F510} サインアウトしてアプリアクセスを取り消す"}setSignOutDisabled(e){this.signOutAllDevicesButton.disabled=e}setSignOutLoading(e){this.signOutAllDevicesButton.disabled=e,this.signOutAllDevicesButton.classList.toggle("loading",e)}};var C=class{constructor(e){this.currentTab="subscription";this.root=a("userOptionsView"),this.backButton=a("backBtn"),this.userEmailElement=a("userOptionsUserEmail"),this.userMenuButton=a("userOptionsUserMenuBtn"),this.userDropdown=a("userOptionsUserDropdown"),this.logoutButton=a("userOptionsLogoutBtn"),this.callbacks=e,this.tabButtons={preferences:a("tabPreferences"),subscription:a("tabSubscription"),security:a("tabSecurity"),faq:a("tabFaq")},this.tabContents={preferences:a("tabContentPreferences"),subscription:a("tabContentSubscription"),security:a("tabContentSecurity"),faq:a("tabContentFaq")},this.subscriptionTab=new y({onUpgrade:e.onUpgrade,onOpenBillingPortal:e.onOpenBillingPortal,onActivateCardlessTrial:e.onActivateCardlessTrial}),this.preferencesTab=new T({onToggleCalendar:e.onToggleCalendar}),this.securityTab=new E({onSignOutAllDevices:e.onSignOutAllDevices}),this.backButton.addEventListener("click",()=>this.callbacks.onBack()),this.setupUserMenu(),this.initializeTabs(),this.switchTab("subscription"),this.loadUserEmail(),this.setupStorageListener()}setupUserMenu(){this.userMenuButton.addEventListener("click",e=>{e.stopPropagation(),this.toggleDropdown()}),this.logoutButton.addEventListener("click",()=>{this.closeDropdown(),this.callbacks.onSignOut()}),document.addEventListener("click",e=>{!this.userMenuButton.contains(e.target)&&!this.userDropdown.contains(e.target)&&this.closeDropdown()})}toggleDropdown(){this.userDropdown.classList.contains("show")?this.closeDropdown():this.openDropdown()}openDropdown(){this.userDropdown.classList.add("show"),this.userMenuButton.classList.add("open")}closeDropdown(){this.userDropdown.classList.remove("show"),this.userMenuButton.classList.remove("open")}async loadUserEmail(){try{let e=await chrome.storage.local.get(["userEmail"]);e.userEmail?this.userEmailElement.textContent=e.userEmail:this.userEmailElement.textContent=""}catch(e){console.error("Failed to load user email:",e)}}setupStorageListener(){chrome.storage.local.onChanged.addListener(e=>{e.userEmail&&(this.userEmailElement.textContent=e.userEmail.newValue||"")})}initializeTabs(){Object.entries(this.tabButtons).forEach(([e,t])=>{t.addEventListener("click",()=>this.switchTab(e))})}switchTab(e){this.currentTab=e,Object.entries(this.tabButtons).forEach(([t,i])=>{t===e?i.classList.add("active"):i.classList.remove("active")}),Object.entries(this.tabContents).forEach(([t,i])=>{t===e?i.classList.add("active"):i.classList.remove("active")})}get element(){return this.root}show(){this.root.classList.add("active")}hide(){this.root.classList.remove("active")}showCalendarsLoading(){this.preferencesTab.showLoading()}showSubscriptionLoading(e){this.subscriptionTab.showLoading(e)}setSignOutDisabled(e){this.securityTab.setSignOutDisabled(e)}setSignOutLoading(e){this.securityTab.setSignOutLoading(e)}showCalendarsError(e){this.preferencesTab.showError(e)}renderCalendars(e,t){this.preferencesTab.render(e,t)}renderSubscriptionStatus(e,t){this.subscriptionTab.render(e,t),this.updatePreferencesTabVisibility(e.hasActiveSubscription)}showSubscriptionError(e){this.subscriptionTab.showError(e)}updatePreferencesTabVisibility(e){e?(this.tabButtons.preferences.style.display="",this.tabContents.preferences.style.display=""):(this.tabButtons.preferences.style.display="none",this.tabContents.preferences.style.display="none",this.currentTab==="preferences"&&this.switchTab("subscription"))}};var L=class{constructor(){this.element=a("loadingState")}show(){this.element.style.display="flex"}hide(){this.element.style.display="none"}};var S=class{constructor(){this.timeoutId=null;this.element=a("notification")}show(e,t="info",i){this.element.textContent=e,this.element.className=`notification ${t}`,this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null),setTimeout(()=>this.element.classList.add("show"),10);let s=i??(t==="error"?6e3:4e3);this.timeoutId=setTimeout(()=>{this.element.classList.remove("show"),this.timeoutId=null},s)}hide(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=null),this.element.classList.remove("show")}};var B=class{constructor(){this.currentView="loading";this.availableCalendars=[];this.selectedCalendarIds=[];this.hasInitialSelection=!1;this.hasActiveSubscription=!0;this.premiumAccessStatus=null;this.canStartCardlessTrial=!1;this.isCheckingAuth=!1;this.isAuthenticated=null;this.postCarouselView=null;this.isCarouselActive=!1;this.subscriptionPollTimer=null;this.loadingView=new L,this.notificationView=new S,this.signInView=new g,this.signInView.bindSignIn(()=>this.authenticate()),this.eventsView=new f({onOptions:()=>{this.showView("options"),this.loadCalendarsForOptions(),this.loadSubscriptionStatus()},notify:(t,i,s)=>this.notificationView.show(t,i,s),sendMessage:t=>this.sendMessage(t),showRateLimitNotification:(t,i)=>this.showRateLimitNotification(t,i),onAuthFailure:()=>{setTimeout(()=>this.showView("signIn"),2e3)}}),this.premiumView=new b({onUpgrade:()=>this.upgradeToPremium(),onStartTrial:()=>void this.activateCardlessTrial(),onOpenOptions:()=>{this.showView("options"),this.loadCalendarsForOptions(),this.loadSubscriptionStatus()}});let e={onBack:()=>this.handleOptionsBack(),onSignOut:()=>void this.signOut(),onSignOutAllDevices:()=>void this.signOutAllDevices(),onToggleCalendar:(t,i,s)=>{this.handleCalendarToggle(t,i,s)},onUpgrade:()=>this.upgradeToPremium(),onOpenBillingPortal:()=>this.openBillingPortal(),onActivateCardlessTrial:()=>void this.activateCardlessTrial()};this.optionsView=new C(e),this.carouselView=new w({onClose:()=>{this.showView("premium")},onFinish:()=>{this.showView("premium")},onActivatePremium:()=>{this.canStartCardlessTrial?this.activateCardlessTrial():this.upgradeToPremium(),this.showView("premium")}}),this.initialize()}async initialize(){this.showView("loading"),await this.checkAuthStatus()}showView(e){switch(this.loadingView.hide(),this.signInView.hide(),this.eventsView.hide(),this.premiumView.hide(),this.optionsView.hide(),this.carouselView.hide(),e){case"loading":this.loadingView.show();break;case"signIn":this.signInView.show();break;case"events":this.eventsView.show();break;case"premium":this.premiumView.show();break;case"options":this.optionsView.show();break;case"carousel":this.carouselView.show();break}this.currentView=e}showRateLimitNotification(e,t){let i=typeof t=="number"&&t>0,s=i?` ${t}秒後に再試行してください${t===1?"":"s"}.`:"",n=`${e}${s}`,r=i?Math.min(2e4,Math.max(6e3,t*1e3)):void 0;return this.notificationView.show(n,"error",r),n}sendMessage(e){return new Promise((t,i)=>{chrome.runtime.sendMessage(e,s=>{chrome.runtime.lastError?i(chrome.runtime.lastError):t(s)})})}updateCardlessTrialEligibility(e){return!e||e.hasActiveSubscription||e.cardlessTrialConsumed?(this.canStartCardlessTrial=!1,!1):(this.canStartCardlessTrial=!0,!0)}async checkAuthStatus(e={}){if(this.isCheckingAuth)return;let{silent:t=!1}=e;this.isCheckingAuth=!0,t||this.showView("loading");try{let s=!!(await this.sendMessage({action:"checkAuth"}))?.authenticated,n=this.isAuthenticated!==s;this.isAuthenticated=s,s?await this.checkSubscriptionAndShowView():(!t||n)&&this.showView("signIn")}catch(i){console.error("Error checking auth status:",i),t||(this.showView("signIn"),this.notificationView.show("認証状態の確認に失敗しました","error"))}finally{this.isCheckingAuth=!1}}async checkSubscriptionAndShowView(){try{let e=await this.sendMessage({action:"getSubscriptionStatus"});if(e.success&&e.data){this.premiumAccessStatus=e.data,this.hasActiveSubscription=e.data.hasActiveSubscription,this.updateCardlessTrialEligibility(e.data),await chrome.storage.local.set({hasActiveSubscription:this.hasActiveSubscription}),this.syncPremiumView();let t=this.hasActiveSubscription?"events":"premium";await this.showPrimaryView(t)}else console.warn("Unable to check subscription status, defaulting to free tier"),this.hasActiveSubscription=!0,this.premiumAccessStatus=null,this.updateCardlessTrialEligibility(null),await chrome.storage.local.set({hasActiveSubscription:!1}),this.syncPremiumView(),await this.showPrimaryView("premium")}catch(e){console.error("Error checking subscription status:",e),this.hasActiveSubscription=!0,this.premiumAccessStatus=null,this.updateCardlessTrialEligibility(null),await chrome.storage.local.set({hasActiveSubscription:!1}),this.syncPremiumView(),await this.showPrimaryView("premium")}}async showPrimaryView(e){e==="events"?(this.showView("events"),await this.eventsView.refresh()):e==="premium"?this.showView("premium"):e==="signIn"?this.showView("signIn"):e==="options"&&this.showView("options")}syncPremiumView(){let e=this.canStartCardlessTrial&&!this.hasActiveSubscription;this.premiumView.setTrialAvailability(e),this.premiumView.setUpgradeAvailability(!e),this.carouselView.setTrialAvailability(e)}async authenticate(){this.signInView.setAuthenticatingState(!0);try{let e=await this.sendMessage({action:"authenticate"});e.success?(this.notificationView.show("認証に成功しました！","success"),await this.checkSubscriptionAndShowView()):this.notificationView.show(e.error||"認証に失敗しました","error")}catch(e){console.error("Authentication error:",e),this.notificationView.show(`認証に失敗しました：${e?.message??"不明なエラー"}`,"error")}finally{this.signInView.setAuthenticatingState(!1)}}async signOut(){this.optionsView.setSignOutLoading(!0);try{await this.sendMessage({action:"signOut"}),this.hasActiveSubscription=!0,this.isAuthenticated=!1,this.notificationView.show("サインアウトしました","success"),this.showView("signIn")}catch(e){console.error("Sign out error:",e),this.notificationView.show("サインアウトに失敗しました","error")}finally{this.optionsView.setSignOutLoading(!1)}}async signOutAllDevices(){this.optionsView.setSignOutDisabled(!0);try{await this.sendMessage({action:"revokeAccess"}),this.hasActiveSubscription=!0,this.isAuthenticated=!1,this.notificationView.show("全てのデバイスからサインアウトし、アプリアクセスを取り消しました","success"),this.showView("signIn")}catch(e){console.error("Sign out all devices error:",e),this.notificationView.show("アクセスの取り消しに失敗しました","error")}finally{this.optionsView.setSignOutDisabled(!1)}}showCarouselOnDemand(){if(this.carouselView.length===0){this.notificationView.show("デモカルーセルは利用できません","info");return}this.carouselView.reset(),this.showView("carousel")}async upgradeToPremium(){try{let e=await this.sendMessage({action:"createCheckoutSession"});if(e.success&&e.url)window.open(e.url,"_blank"),this.notificationView.show("支払いページを開いています...","info"),this.startSubscriptionPolling();else throw new Error(e.error||"Failed to create checkout session")}catch(e){console.error("Failed to create checkout session:",e),this.notificationView.show("チェックアウトの開始に失敗しました。もう一度お試しください。","error")}}async openBillingPortal(){try{let e=await this.sendMessage({action:"createBillingPortalSession"});if(e.success&&e.url)window.open(e.url,"_blank"),this.notificationView.show("サブスクリプション管理を開いています...","info");else throw new Error(e.error||"Failed to create billing portal session")}catch(e){console.error("Failed to create billing portal session:",e),this.notificationView.show("課金ポータルを開けませんでした。もう一度お試しください。","error")}}startSubscriptionPolling(){this.subscriptionPollTimer&&clearInterval(this.subscriptionPollTimer);let e=0,t=24;this.subscriptionPollTimer=setInterval(async()=>{e+=1;try{let i=await this.sendMessage({action:"getSubscriptionStatus"});i.success&&i.data&&i.data.hasActiveSubscription?(clearInterval(this.subscriptionPollTimer),this.subscriptionPollTimer=null,this.hasActiveSubscription=!0,await chrome.storage.local.set({hasActiveSubscription:!0}),this.notificationView.show("\u{1F389} プレミアムが有効化されました！ようこそ！","success"),setTimeout(()=>{this.showPrimaryView("events")},1500)):i.code==="RATE_LIMITED"&&console.warn("Subscription status polling rate limited",{retryAfterSeconds:i.retryAfterSeconds})}catch(i){console.error("Error polling subscription status:",i)}e>=t&&(clearInterval(this.subscriptionPollTimer),this.subscriptionPollTimer=null)},5e3)}async refreshSubscriptionStatus(){try{let e=await this.sendMessage({action:"getSubscriptionStatus"});if(e.success&&e.data)this.premiumAccessStatus=e.data,this.hasActiveSubscription=e.data.hasActiveSubscription,this.updateCardlessTrialEligibility(e.data),await chrome.storage.local.set({hasActiveSubscription:this.hasActiveSubscription}),this.syncPremiumView(),this.hasActiveSubscription?(this.notificationView.show("\u{1F389} プレミアムサブスクリプションが見つかりました！","success"),setTimeout(()=>{this.showPrimaryView("events")},1e3)):this.notificationView.show("有効なサブスクリプションが見つかりません","info");else if(e.code==="RATE_LIMITED"){let t=typeof e.error=="string"&&e.error.length>0?e.error:"短時間に多数のサブスクリプション確認が行われました。しばらくしてからお試しください。";this.showRateLimitNotification(t,e.retryAfterSeconds);return}else throw new Error(e.error||"Failed to check subscription")}catch(e){if(console.error("Error refreshing subscription status:",e),e?.code==="RATE_LIMITED"){let t=e?.message||"短時間に多数のサブスクリプション確認が行われました。しばらくしてからお試しください。";this.showRateLimitNotification(t,e?.retryAfterSeconds)}else this.notificationView.show("サブスクリプション状態の確認に失敗しました","error")}}async activateCardlessTrial(){this.notificationView.show("プレミアムトライアルを有効化中...","info");try{let e=await this.sendMessage({action:"startCardlessTrial"});if(e.success&&e.data){this.premiumAccessStatus=e.data,this.hasActiveSubscription=e.data.hasActiveSubscription,this.updateCardlessTrialEligibility(e.data),await chrome.storage.local.set({hasActiveSubscription:this.hasActiveSubscription}),this.syncPremiumView(),this.optionsView.renderSubscriptionStatus(e.data,{canStartCardlessTrial:this.canStartCardlessTrial}),this.notificationView.show("\u{1F389} プレミアムトライアルが有効化されました！","success"),this.hasActiveSubscription&&await this.showPrimaryView("events");return}e.status&&(this.premiumAccessStatus=e.status,this.hasActiveSubscription=e.status.hasActiveSubscription,this.updateCardlessTrialEligibility(e.status),this.syncPremiumView(),this.optionsView.renderSubscriptionStatus(e.status,{canStartCardlessTrial:this.canStartCardlessTrial}),this.hasActiveSubscription&&await this.showPrimaryView("events"));let t=e.code==="TRIAL_ALREADY_CONSUMED"?"カードレストライアルは既に使用済みです。":e.code==="TRIAL_ALREADY_ACTIVE"?"既にプレミアムアクセスがあります。":e.error||"プレミアムトライアルの開始に失敗しました。";this.notificationView.show(t,"error")}catch(e){console.error("Failed to activate cardless trial:",e),this.notificationView.show(`プレミアムトライアルの有効化に失敗しました： ${e?.message??"不明なエラー"}`,"error")}}async loadSubscriptionStatus(){this.optionsView.showSubscriptionLoading("サブスクリプション状態を読み込み中...");try{let e=await this.sendMessage({action:"getSubscriptionStatus"});if(e.success&&e.data)this.premiumAccessStatus=e.data,this.updateCardlessTrialEligibility(e.data),this.syncPremiumView(),this.optionsView.renderSubscriptionStatus(e.data,{canStartCardlessTrial:this.canStartCardlessTrial});else throw new Error(e.error||"サブスクリプション状態の読み込みに失敗しました")}catch(e){console.error("サブスクリプション状態の読み込みに失敗しました:",e),this.optionsView.showSubscriptionError("サブスクリプション状態を読み込めませんでした"),this.premiumAccessStatus&&(this.syncPremiumView(),this.optionsView.renderSubscriptionStatus(this.premiumAccessStatus,{canStartCardlessTrial:this.canStartCardlessTrial}))}}async loadCalendarsForOptions(){if(!this.hasActiveSubscription)return;this.optionsView.showCalendarsLoading();let e=await this.loadCachedCalendars();e?(this.availableCalendars=e,!this.hasInitialSelection&&this.availableCalendars.length>0&&(this.selectedCalendarIds=this.availableCalendars.map(t=>t.id)),this.optionsView.renderCalendars(this.availableCalendars,this.selectedCalendarIds),this.fetchCalendarsInBackground()):await this.fetchCalendarsInBackground()}async fetchCalendarsInBackground(){try{let e=await this.sendMessage({action:"listCalendarsDirect"});if(e.success){this.availableCalendars=e.calendars||[],this.selectedCalendarIds=e.selectedCalendarIds||[],this.hasInitialSelection=e.hasInitialSelection??!1,await this.saveCachedCalendars(this.availableCalendars),!this.hasInitialSelection&&this.availableCalendars.length>0&&(this.selectedCalendarIds=this.availableCalendars.map(t=>t.id));try{await chrome.storage.local.set({selectedCalendarIds:this.selectedCalendarIds,selectedCalendarIdsUpdatedAt:Date.now()})}catch(t){console.warn("Failed to persist selected calendar IDs locally",t)}this.optionsView.renderCalendars(this.availableCalendars,this.selectedCalendarIds)}else if(e.code==="RATE_LIMITED"){let t=typeof e.error=="string"&&e.error.length>0?e.error:"短時間に多数のカレンダー更新が行われました。しばらくしてからお試しください。",i=this.showRateLimitNotification(t,e.retryAfterSeconds);this.optionsView.showCalendarsError(i);return}else throw new Error(e.error||"カレンダーの読み込みに失敗しました")}catch(e){if(console.error("Error loading calendars:",e),e?.code==="RATE_LIMITED"){let t=e?.message||"短時間に多数のカレンダー更新が行われました。しばらくしてからお試しください。",i=this.showRateLimitNotification(t,e?.retryAfterSeconds);this.optionsView.showCalendarsError(i)}else this.optionsView.showCalendarsError("カレンダーの読み込みに失敗しました"),this.notificationView.show("カレンダーの読み込みに失敗しました","error")}}async handleCalendarToggle(e,t,i){let s=[...this.selectedCalendarIds];t?this.selectedCalendarIds.includes(e)||this.selectedCalendarIds.push(e):this.selectedCalendarIds=this.selectedCalendarIds.filter(n=>n!==e);try{await this.updateCalendarPreferences(this.selectedCalendarIds),await this.eventsView.clearCache(),this.notificationView.show("カレンダー選択を更新しました","success")}catch(n){console.error("Failed to update calendar preferences:",n),this.notificationView.show("カレンダー選択の更新に失敗しました","error"),i.checked=!t,this.selectedCalendarIds=s}}handleOptionsBack(){this.hasActiveSubscription?this.showPrimaryView("events"):this.showPrimaryView("premium")}async updateCalendarPreferences(e){try{let t=await this.sendMessage({action:"updateCalendarPreferences",selectedCalendarIds:e});if(t.success)await chrome.storage.local.set({selectedCalendarIds:e,selectedCalendarIdsUpdatedAt:Date.now()});else if(t.code==="RATE_LIMITED"){let i=typeof t.error=="string"&&t.error.length>0?t.error:"短時間に多数のカレンダー設定更新が行われました。しばらくしてからお試しください。",s=new Error(i);throw s.code="RATE_LIMITED",typeof t.retryAfterSeconds=="number"&&(s.retryAfterSeconds=t.retryAfterSeconds),s}else throw new Error(t.error||"Failed to update preferences")}catch(t){throw console.error("Error updating calendar preferences:",t),t}}async loadCachedCalendars(){try{let e=await chrome.storage.local.get(["cachedCalendars"]);if(e.cachedCalendars){let t=e.cachedCalendars,i=Date.now()-t.timestamp,s=60*60*1e3;if(i<s)return t.calendars}}catch(e){console.error("Error loading cached calendars:",e)}return null}async saveCachedCalendars(e){try{await chrome.storage.local.set({cachedCalendars:{calendars:e,timestamp:Date.now()}})}catch(t){console.error("Error caching calendars:",t)}}};document.addEventListener("DOMContentLoaded",()=>{new B});})();
